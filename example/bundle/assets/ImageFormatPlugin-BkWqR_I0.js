import{h as S,b9 as E,q as T}from"./three.module-CQU0seT4.js";const x=Symbol("TILE_X"),L=Symbol("TILE_Y"),p=Symbol("TILE_LEVEL");class y{get tiling(){return this.imageSource.tiling}constructor(e={}){const{pixelSize:t=.01,center:i=!1,useRecommendedSettings:s=!0,imageSource:n=null}=e;this.priority=-10,this.tiles=null,this.imageSource=n,this.pixelSize=t,this.center=i,this.useRecommendedSettings=s}init(e){this.useRecommendedSettings&&(e.errorTarget=1),this.tiles=e,this.imageSource.fetchOptions=e.fetchOptions,this.imageSource.fetchData=(t,i)=>(e.invokeAllPlugins(s=>t=s.preprocessURL?s.preprocessURL(t,null):t),e.invokeOnePlugin(s=>s!==this&&s.fetchData&&s.fetchData(t,i)))}async loadRootTileSet(){const{tiles:e,imageSource:t}=this;let i=e.rootURL;return e.invokeAllPlugins(s=>i=s.preprocessURL?s.preprocessURL(i,null):i),await t.init(i),this.getTileset(i)}async parseToMesh(e,t,i,s,n){if(n.aborted)return null;const o=t[x],c=t[L],a=t[p],r=await this.imageSource.processBufferToTexture(e);if(n.aborted)return r.dispose(),r.image.close(),null;this.imageSource.setData(o,c,a,r);let l=1,h=1,f=0,g=0,m=0;const u=t.boundingVolume.box;u&&([f,g,m]=u,l=u[3],h=u[7]);const d=new S(new E(2*l,2*h),new T({map:r,transparent:!0}));return d.position.set(f,g,m),d}preprocessNode(e){const{tiling:t}=this,i=t.maxLevel;e[p]<i&&e.parent!==null&&this.expandChildren(e)}disposeTile(e){const t=e[x],i=e[L],s=e[p],{imageSource:n}=this;n.has(t,i,s)&&n.release(t,i,s)}getTileset(e){const{tiling:t,tiles:i}=this,s=t.minLevel,{tileCountX:n,tileCountY:o}=t.getLevel(s),c=[];for(let r=0;r<n;r++)for(let l=0;l<o;l++){const h=this.createChild(r,l,s);h!==null&&c.push(h)}const a={asset:{version:"1.1"},geometricError:1e5,root:{refine:"REPLACE",geometricError:1e5,boundingVolume:this.createBoundingVolume(0,0,-1),children:c,[p]:-1,[x]:0,[L]:0}};return i.preprocessTileSet(a,e),a}getUrl(e,t,i){return this.imageSource.getUrl(e,t,i)}createBoundingVolume(e,t,i){const{center:s,pixelSize:n,tiling:o}=this,{pixelWidth:c,pixelHeight:a}=o.getLevel(o.maxLevel),[r,l,h,f]=i===-1?o.getFullBounds(!0):o.getTileBounds(e,t,i,!0);let g=(h-r)/2,m=(f-l)/2,u=r+g,d=l+m;return s&&(u-=.5,d-=.5),u*=c*n,g*=c*n,d*=a*n,m*=a*n,{box:[u,d,0,g,0,0,0,m,0,0,0,0]}}createChild(e,t,i){const{pixelSize:s,tiling:n}=this;if(!n.getTileExists(e,t,i))return null;const{pixelWidth:o,pixelHeight:c}=n.getLevel(n.maxLevel),{pixelWidth:a,pixelHeight:r}=n.getLevel(i);return{refine:"REPLACE",geometricError:s*(Math.max(o/a,c/r)-1),boundingVolume:this.createBoundingVolume(e,t,i),content:{uri:this.getUrl(e,t,i)},children:[],[x]:e,[L]:t,[p]:i}}expandChildren(e){const t=e[p],i=e[x],s=e[L];for(let n=0;n<2;n++)for(let o=0;o<2;o++){const c=this.createChild(2*i+n,2*s+o,t+1);c&&e.children.push(c)}}}export{y as I,p as T,x as a,L as b};
//# sourceMappingURL=ImageFormatPlugin-BkWqR_I0.js.map
